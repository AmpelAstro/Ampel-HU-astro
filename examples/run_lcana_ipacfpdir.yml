name: run_lcana_ipacfpdir
mongo:
  prefix:  bts_ipacfp_strictbase_full
  reset: true
channel:
- name: lcana
  access: [ZTF, ZTF_PUB, ZTF_PRIV]
  policy: []
  version: 1
task:
- title: FPT0
  template: hash_t2_config
  unit: AlertConsumer
  config:
    iter_max: 100000000
    supplier:
      unit: ZTFIPACForcedPhotometryAlertSupplier
      config:
        alert_history: true
        name_file: /Users/jnordin/data/ztf/bts/bts_explorer_241122.csv
        file_keys: 
          id: ZTFID
          ra: RA
          dec: Dec
          raunit: hourangle
          decunit: deg
        days_prepeak: 150
        days_postpeak: 200
        baseline_min_det_pre: 25.0 # Min detections prior to transient region in a band/quad to include 
        baseline_min_det_post: 25.0 # Min detections after transient region in a band/quad to include 
        loader:
          unit: DirFileNamesLoader
          config:
            folder: /Users/jnordin/data/ztf/ipac_fp/dr3_bts
            extension: "txt"
    shaper: ZiDataPointShaper
    compiler_opts: ZiCompilerOptions
    directives:
    - channel: lcana
      ingest:
        mux:
          combine:
          - state_t2:
            - config:
                max_redshift_category: 7
                t2_dependency:
                - config: &catalog_match_config
                    catalogs:
                      AAVSOVSX:
                        keys_to_append:
                        - TYPE
                        rs_arcsec: 3
                        use: extcats
                      DESIDR1:
                        keys_to_append:
                        - z
                        - spectype
                        - subtype
                        - ra
                        - dec
                        - desi_target
                        - mag_g
                        - mag_r
                        - mag_z
                        post_filter: null
                        pre_filter: null
                        rs_arcsec: 10.0
                        use: extcats
                      DESIDR1_stars:
                        keys_to_append:
                        - z
                        - spectype
                        - subtype
                        - ra
                        - dec
                        - desi_target
                        - mag_g
                        - mag_r
                        - mag_z
                        post_filter: null
                        pre_filter: null
                        rs_arcsec: 3.0
                        use: extcats
                      GAIADR2:
                        keys_to_append:
                        - Mag_G
                        - PMRA
                        - ErrPMRA
                        - PMDec
                        - ErrPMDec
                        - Plx
                        - ErrPlx
                        - ExcessNoise
                        - ExcessNoiseSig
                        rs_arcsec: 3.0
                        use: catsHTM
                      GLADEv23:
                        keys_to_append:
                        - z
                        - dist
                        - dist_err
                        - flag1
                        - flag2
                        - flag3
                        rs_arcsec: 10
                        use: extcats
                      LAMOSTDR4:
                        keys_to_append:
                        - objtype
                        - class
                        - subclass
                        - snrg
                        rs_arcsec: 3
                        use: extcats
                      LSPhotoZZou:
                        all: false
                        keys_to_append:
                        - photoz
                        - ra
                        - dec
                        - e_photoz
                        - specz
                        - _6
                        - logMassBest
                        - logMassInf
                        - logMassSup
                        post_filter: null
                        pre_filter: null
                        rs_arcsec: 10.0
                        use: extcats
                      NEDLVS:
                        keys_to_append:
                        - objname
                        - objtype
                        - z
                        - z_unc
                        - z_tech
                        - z_qual
                        - z_qual_flag
                        - ebv
                        post_filter: null
                        pre_filter: null
                        rs_arcsec: 10.0
                        use: extcats
                      NEDz:
                        keys_to_append:
                        - ObjType
                        - Velocity
                        - z
                        rs_arcsec: 10.0
                        use: catsHTM
                      NEDz_extcats:
                        keys_to_append:
                        - ObjType
                        - Velocity
                        - z
                        post_filter:
                          z:
                            $gte: 0.002
                            $lte: 0.03
                        pre_filter: null
                        rs_arcsec: 60.0
                        use: extcats
                      PS1:
                        keys_to_append:
                        - gPSFMag
                        - gPSFMagErr
                        - rPSFMag
                        - rPSFMagErr
                        - iPSFMag
                        - iPSFMagErr
                        - zPSFMag
                        - zPSFMagErr
                        - yPSFMag
                        - yPSFMagErr
                        rs_arcsec: 10.0
                        use: catsHTM
                      PS1_photoz:
                        keys_to_append:
                        - raMean
                        - decMean
                        - z_phot
                        - z_photErr
                        - z_phot0
                        - _2
                        post_filter: null
                        pre_filter: null
                        rs_arcsec: 10.0
                        use: extcats
                      SDSSDR10:
                        keys_to_append:
                        - type
                        - flags
                        rs_arcsec: 10.0
                        use: catsHTM
                      SDSS_spec:
                        all: false
                        keys_to_append:
                        - z
                        - bptclass
                        - subclass
                        rs_arcsec: 10.0
                        use: extcats
                      TNS:
                        keys_to_append:
                        - objname
                        - name
                        - redshift
                        - sourceid
                        - type
                        - internal_name
                        - internal_names
                        - object_type
                        - objid
                        - source
                        post_filter: null
                        pre_filter: null
                        rs_arcsec: 3.0
                        use: extcats
                      WISE:
                        keys_to_append:
                        - Mag_W1
                        - MagErr_W1
                        - Mag_W2
                        - MagErr_W2
                        - Mag_W3
                        - MagErr_W3
                        rs_arcsec: 10.0
                        use: catsHTM
                      brescia:
                        keys_to_append:
                        - z
                        - subclass
                        rs_arcsec: 3
                        use: extcats
                      milliquas:
                        keys_to_append:
                        - broad_type
                        - name
                        - redshift
                        - qso_prob
                        rs_arcsec: 3
                        use: extcats
                      twoMPZ:
                        keys_to_append:
                        - zPhoto
                        - ra
                        - dec
                        - zSpec
                        post_filter: null
                        pre_filter: null
                        rs_arcsec: 10.0
                        use: extcats
                      wiseScosPhotoz:
                        keys_to_append:
                        - zPhoto_Corr
                        - ra
                        - dec
                        - wiseID
                        - w1mCorr
                        - w2mCorr
                        post_filter: null
                        pre_filter: null
                        rs_arcsec: 10.0
                        use: extcats
                      wise_color:
                        keys_to_append:
                        - W1mW2
                        - W2mW3
                        - W1mag
                        post_filter: null
                        pre_filter: null
                        rs_arcsec: 10.0
                        use: extcats
                  link_override:
                    filter: PPSFilter
                    select: first
                    sort: jd
                  unit: T2CatalogMatch
              unit: T2DigestRedshifts
            - unit: T2MatchBTS
            - config:
                lightcurve_bands:
                  ztfg: ztfg
                  ztfi: ztfi
                  ztfr: ztfr
                lightcurve_features_flux:
                  AndersonDarlingNormal: null
                  Eta: null
                  EtaE: null
                  ExcessVariance: null
                  Kurtosis: null
                  LinearFit: null
                  MaximumSlope: null
                  Periodogram:
                    peaks: 1
                  Skew: null
                  StandardDeviation: null
                  StetsonK: null
                rainbow_fit:
                  band_wave_aa:
                    ztfg: 4813
                    ztfi: 7883
                    ztfr: 6421
                significant_bands:
                - ztfg
                - ztfr
                - ztfi
                t_cadence: 3
                tabulator:
                - unit: ZTFFPTabulator
              unit: T2TabulatorRiseDecline
            - config:
                fixed_z: 0.08
#                plot_props:
#                  disk_save: /Users/jnordin/tmp/ztfsalt2z
#                  fig_text:
#                    arg_keys:
#                    - stock
#                    - model
#                    - redshift_kind
#                    - chisq
#                    - ndof
#                    format_str: "%s %s \nz-source %s \nchisq %.2f ndof %s"
#                  file_name:
#                    arg_keys:
#                    - stock
#                    - model
#                    - redshift_kind
#                    format_str: '%s_%s_%s.svg'
#                  height: 6
#                  id_mapper: ZTFIdMapper
#                  tags:
#                  - SALT
#                  - SNCOSMO
#                  title:
#                    arg_keys:
#                    - stock
#                    - model
#                    - redshift_kind
#                    format_str: '%s %s %s'
#                  width: 10
                redshift_kind: null
                sncosmo_model_name: salt2
                t2_dependency:
                - config: *catalog_match_config
                  link_override:
                    filter: PPSFilter
                    select: first
                    sort: jd
                  unit: T2CatalogMatch
                tabulator:
                - config:
                    inclusion_sigma: 3
                  unit: ZTFFPTabulator
              unit: T2RunSncosmo
            - config:
                max_redshift_category: 7
#                plot_props:
#                  disk_save: /Users/jnordin/tmp/ztfsalt
#                  fig_text:
#                    arg_keys:
#                    - stock
#                    - model
#                    - redshift_kind
#                    - chisq
#                    - ndof
#                    format_str: "%s %s \nz-source %s \nchisq %.2f ndof %s"
#                  file_name:
#                    arg_keys:
#                    - stock
#                    - model
#                    - redshift_kind
#                    format_str: '%s_%s_%s.svg'
#                  height: 6
#                  id_mapper: null
#                  tags:
#                  - SALT
#                  - SNCOSMO
#                  title:
#                    arg_keys:
#                    - stock
#                    - model
#                    - redshift_kind
#                    format_str: '%s %s %s'
#                  width: 10
                redshift_kind: T2DigestRedshifts
                sncosmo_model_name: salt2
                t2_dependency:
                - config: *catalog_match_config
                  link_override:
                    filter: PPSFilter
                    select: first
                    sort: jd
                  unit: T2CatalogMatch
                tabulator:
                - config:
                    inclusion_sigma: 3
                  unit: ZTFFPTabulator
              unit: T2RunSncosmo
            - config:
                add_parsnip_from: snlong
                classifier_name: rdp
                classifier_version: '0.1'
                max_redshift_category: 7
                parsnip_zeropoint_offset: 0
#                parsnipplot_dir: /Users/jnordin/tmp/ztfparsnip_fp
#                parsnipplot_suffix: png
                paths_parsnip:
                  snlong:
                    classifier: /Users/jnordin/data/models/parsnip/v2_Mar2025/noiztf_classifier_sncut_scale3_z3_subsamp0.9_cadscale0.5_seed0.pkl
                    model: /Users/jnordin/data/models/parsnip/v2_Mar2025/noiztfmodel_sncut_scale3_z3_subsamp0.9_cadscale0.5_seed0.pt
                paths_xgbbinary: {}
                paths_xgbmulti:
                  early:
                    classes:
                    - slsn
                    - snia
                    - snibc
                    - snii
                    - sniin
                    path: /Users/jnordin/data/models/xgb/latest/xgb24_sn_long_earlyphase
                  last_parsnip:
                    classes:
                    - slsn
                    - snia
                    - snibc
                    - snii
                    - sniin
                    path: /Users/jnordin/data/models/xgb/latest/xgb24_sn_long_lastalert_parsnip
                  last_prd:
                    classes:
                    - slsn
                    - snia
                    - snibc
                    - snii
                    - sniin
                    path: /Users/jnordin/data/models/xgb/latest/xgb24_sn_long_lastalert_risedeclineparsnip
                  last_risedec:
                    classes:
                    - slsn
                    - snia
                    - snibc
                    - snii
                    - sniin
                    path: /Users/jnordin/data/models/xgb/latest/xgb24_sn_long_lastalert_risedecline
                  later:
                    classes:
                    - slsn
                    - snia
                    - snibc
                    - snii
                    - sniin
                    path: /Users/jnordin/data/models/xgb/latest/xgb24_sn_long_latephase
                  sample1:
                    classes:
                    - slsn
                    - snia
                    - snibc
                    - snii
                    - sniin
                    path: /Users/jnordin/data/models/xgb/latest/xgb24_sn_long_sample1
                redshift_kind: T2DigestRedshifts
                return_features: true
                significant_bands:
                - ztfg
                - ztfr
                - ztfi
                t2_dependency:
                - config: *catalog_match_config
                  link_override:
                    filter: PPSFilter
                    select: first
                    sort: jd
                  unit: T2CatalogMatch
                t_cadence: 3.0
                tabulator:
                - config:
                    inclusion_sigma: 2
                  unit: ZTFFPTabulator
              unit: T2RunParsnipRiseDecline
            unit: ZiT1Combiner
          insert:
            point_t2:
            - config: *catalog_match_config
              ingest:
                filter: PPSFilter
                select: first
                sort: jd
              unit: T2CatalogMatch
          unit: ZiMongoMuxer


