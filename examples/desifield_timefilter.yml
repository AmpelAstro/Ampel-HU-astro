name: testA
parameters:
- name: channelname
  value: atest
- name: date
  value: "2023-06-10"
- name: deltat
  value: 10
- name: field
  value: 2457

mongo:
  prefix: healpixWideTimeFoo
  reset: false 

channel:
- name: atest
  access: [ZTF, ZTF_PUB, ZTF_PRIV]
  policy: []

task:


- title: token
  unit: T3Processor
  config:
    raise_exc: true
    execute:
      - unit: T3PlainUnitExecutor
        config:
          target:
            unit: T3ZTFArchiveTokenGenerator
            config:
              date_str: "{{ job.parameters.date }}"
              delta_t: "{{ job.parameters.deltat }}"
              resource_name: ztf_stream_token
              candidate:
                ndethist:
                  $gte: 3.
                isdiffpos: 
                  $in:
                  - "t"
                  - "1"
                field: 
                  $in:
                  - "{{ job.parameters.field }}"

- title: NearbyInfantReact
  unit: AlertConsumer
  config:
    iter_max: 100000
    supplier:
      unit: ZiAlertSupplier
      config:
        deserialize: null
        loader:
          unit: ZTFArchiveAlertLoader
          config:
            resource_name: ztf_stream_token
              
    shaper: ZiDataPointShaper
    directives:
    - channel: "{{ job.parameters.channelname }}"
      filter:
        config:
          gaia_excessnoise_sig_max: 999
          gaia_plx_signif: 3
          gaia_pm_signif: 3
          gaia_rs: 20
          gaia_veto_gmag_max: 20
          gaia_veto_gmag_min: 9
          min_ndet: 3
          min_tspan: 5
          max_tspan: 9999999
          min_archive_tspan: 3
          max_archive_tspan: 9999999
          min_gal_lat: 14
          min_rb: 0.3
          min_sso_dist: 20
          ps1_confusion_rad: 3         # Turns off PS1 confusion check. Maybe redundnant with drb?
          ps1_confusion_sg_tol: 0.1
          ps1_sgveto_rad: 1
          ps1_sgveto_th: 0.8
          max_fwhm: 5.5
          max_elong: 2
          max_magdiff: 1
          max_nbad: 2
          min_magfromlim: 0.2 
          jd_rej_sigma: 5.0 
          min_masked_duration: 1.9
          max_masked_duration: 360.0
        on_stock_match: bypass
        unit: TimeDistributionFilter
      ingest:
        mux:
          combine:
          - state_t2:
            - unit: T2MatchBTS
            - unit: T2LightCurveSummary
            unit: ZiT1Combiner
          insert:
            point_t2:
            - config: 
                catalogs:
                  DESISV3:
                    keys_to_append:
                    - z
                    - zerr
                    - zwarn
                    - spectype
                    - subtype
                    - maskbits
                    - sv3_desi_target
                    - sv3_bgs_target
                    - sv3_mws_target
                    - sv3_scnd_target
                    rs_arcsec: 10.0
                    use: extcats
                  NEDz:
                    keys_to_append:
                    - ObjType
                    - Velocity
                    - z
                    rs_arcsec: 10.0
                    use: catsHTM
                  NEDLVS:
                    keys_to_append:
                    - objname
                    - objtype
                    - dec
                    - z_unc
                    - z_tech
                    - z_qual
                    - z_qual_flag
                    - z
                    rs_arcsec: 10.0
                    use: extcats
                  SDSS_spec:
                    keys_to_append:
                    - z
                    - bptclass
                    - subclass
                    rs_arcsec: 10.0
                    use: extcats
              ingest:
                filter: PPSFilter
                select: first
                sort: jd
              unit: T2CatalogMatch
          unit: ZiMongoMuxer


