name: ligo-healpix

mongo:
  prefix: dumpme
  reset: true

channel:
- name: ligo
  access: [ZTF, ZTF_PUB, ZTF_PRIV]
  policy: []



task:

- title: HealpixToAlertToken
  unit: T3Processor
  config:
    raise_exc: true
    execute:
      - unit: T3PlainUnitExecutor
        config:
          target:
            unit: HealpixTokenGenerator
            config:
              pvalue_limit: 0.8 
              map_name: "S191222n.fits.gz" 
              map_url: "https://gracedb.ligo.org/api/superevents/S191222n/files/LALInference.fits.gz"
              map_dir: '/home/jnordin/tmp'
              archive_token:
                label: ztf/archive/token
- title: ProcessAlerts
  unit: HealpixTokenConsumer
  config:
    map_name: "S191222n.fits.gz"
    iter_max: 1000000
    supplier:
      unit: ZiAlertSupplier
      config:
        deserialize: null
        loader:
          unit: ZTFArchiveAlertLoader
          config:
            resource_name: "S191222n.fits.gz_token"
    shaper: ZiDataPointShaper
    directives:
    - channel: ligo
      filter:
        config:
          gaia_excessnoise_sig_max: 999
          gaia_plx_signif: 3
          gaia_pm_signif: 3
          gaia_rs: 20
          gaia_veto_gmag_max: 20
          gaia_veto_gmag_min: 9
          min_ndet: 1
          min_tspan: -99
          max_tspan: 99
          min_archive_tspan: -99
          max_archive_tspan: 100
          min_drb: 0.995
          min_gal_lat: 14
          min_rb: 0.3
          min_sso_dist: 20
          ps1_confusion_rad: 3
          ps1_confusion_sg_tol: 0.1
          ps1_sgveto_rad: 1
          ps1_sgveto_th: 0.8
          max_fwhm: 5.5
          max_elong: 2
          max_magdiff: 1
          max_nbad: 2
        on_stock_match: bypass
        unit: DecentFilter
      ingest:
        mux:
          combine:
          - state_t2:
            - config: &digest_redshift_config
                max_redshift_category: 6
                t2_dependency:
                - config: &catalog_match_config
                    catalogs:
                      GLADEv23:
                        keys_to_append:
                        - z
                        - dist
                        - dist_err
                        - flag1
                        - flag2
                        - flag3
                        rs_arcsec: 10
                        use: extcats
                      NEDz:
                        keys_to_append:
                        - ObjType
                        - Velocity
                        - z
                        rs_arcsec: 10.0
                        use: catsHTM
                      NEDz_extcats:
                        keys_to_append:
                        - ObjType
                        - Velocity
                        - z
                        post_filter:
                          z:
                            $gte: 0.002
                            $lte: 0.03
                        pre_filter: null
                        rs_arcsec: 60.0
                        use: extcats
                      SDSS_spec:
                        keys_to_append:
                        - z
                        - bptclass
                        - subclass
                        rs_arcsec: 10.0
                        use: extcats
                      LSPhotoZZou:
                        all: true
                        keys_to_append:
                        - photoz
                        - ra
                        - dec
                        - e_photoz
                        - specz
                        - _6
                        - logMassBest
                        - logMassInf
                        - logMassSup
                        rs_arcsec: 30.0
                        use: extcats
                      twoMPZ:
                        all: true
                        keys_to_append:
                        - zPhoto
                        - ra
                        - dec
                        - zSpec
                        rs_arcsec: 30.0
                        use: extcats
                      wiseScosPhotoz:
                        all: true
                        keys_to_append:
                        - zPhoto_Corr
                        - ra
                        - dec
                        - wiseID
                        - w1mCorr
                        - w2mCorr
                        rs_arcsec: 30.0
                        use: extcats
                      PS1_photoz:
                        keys_to_append:
                        - raMean
                        - decMean
                        - z_phot
                        - z_photErr
                        - z_phot0
                        - _2
                        rs_arcsec: 10.
                        use: extcats
                        pre_filter: null
                        post_filter: null
                  link_override:
                    filter: PPSFilter
                    select: first
                    sort: jd
                  unit: T2CatalogMatch
              unit: T2DigestRedshifts
            - config:
                explosion_time_jd: StockTriggerTime
                max_ampelz_group: 7
                redshift_kind: T2DigestRedshifts
                t2_dependency:
                - config: *digest_redshift_config
                  unit: T2DigestRedshifts
                - unit: T2PropagateStockInfo
                tabulator:
                  - unit: ZTFT2Tabulator
                plot_props:
                  file_name:
                    format_str: "%s_%s_%s.svg"
                    arg_keys:
                      - stock
                      - model
                      - redshift_kind
                  title:
                    format_str: "%s %s %s"
                    arg_keys:
                      - stock
                      - model
                      - redshift_kind
                  fig_text:
                    format_str: "%s %s \nz-source %s \nchisq %.2f ndof %s"
                    arg_keys:
                      - stock
                      - model
                      - redshift_kind
                      - chisq
                      - ndof
                  width: 10
                  height: 6
                  id_mapper: null
                  disk_save: /home/jnordin/tmp/
              unit: T2RunPossis
            unit: ZiT1Combiner
          insert:
            point_t2:
            - config: *catalog_match_config
              ingest:
                filter: PPSFilter
                select: first
                sort: jd
              unit: T2CatalogMatch
          unit: ZiArchiveMuxer
          config:
            future_days: 50
            history_days: 50
        stock_t2:
        - unit: T2PropagateStockInfo
          config:
            prop_paths:
              trigger_time:
              - journal
              - healpix
              - trigger_time
              prob_contour:
              - journal
              - healpix
              - cumprob
              healpix_map:
              - journal
              - healpix
              - map_name
              

- title: Run T2s
  unit: T2Worker
  config:
    send_beacon: false
    raise_exc: true

